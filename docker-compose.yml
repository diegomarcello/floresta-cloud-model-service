version: '3.8'

services:
  # Message Broker
  redis:
    image: redis:alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "${REDIS_PORT}:6379"
    networks:
      - floresta-net

  # Database
  mongo:
    image: mongo:latest
    ports:
      - "${MONGO_PORT}:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    volumes:
      - mongo_data:/data/db
    networks:
      - floresta-net

  # Central Manager
  master:
    build:
      context: .
      dockerfile: services/master/Dockerfile
    depends_on:
      - redis
      - mongo
    volumes:
      - ./services/master/src:/app/src
      - ./shared:/shared
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MONGO_HOST=${MONGO_HOST}
      - MONGO_PORT=${MONGO_PORT}
      - MONGO_USER=${MONGO_USER}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MONGO_DB=${MONGO_DB}
      - POLL_INTERVAL=${MASTER_POLL_INTERVAL}
    networks:
      - floresta-net

  # Intelligence Services
  ml_inference:
    build:
      context: .
      dockerfile: services/ml_inference/Dockerfile
    depends_on:
      - redis
      - mongo
    volumes:
      - ./services/ml_inference/src:/app/src
      - ./shared:/shared
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MONGO_HOST=${MONGO_HOST}
      - MONGO_PORT=${MONGO_PORT}
      - MONGO_USER=${MONGO_USER}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MONGO_DB=${MONGO_DB}
      - MODEL_VERSION=${ML_MODEL_VERSION}
    networks:
      - floresta-net

  rpa_worker:
    build:
      context: .
      dockerfile: services/rpa_worker/Dockerfile
    depends_on:
      - redis
      - mongo
    volumes:
      - ./services/rpa_worker/src:/app/src
      - ./shared:/shared
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MONGO_HOST=${MONGO_HOST}
      - MONGO_PORT=${MONGO_PORT}
      - MONGO_USER=${MONGO_USER}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MONGO_DB=${MONGO_DB}
      - TIMEOUT=${RPA_TIMEOUT}
    networks:
      - floresta-net

  data_collector:
    build:
      context: .
      dockerfile: services/data_collector/Dockerfile
    depends_on:
      - redis
      - mongo
    volumes:
      - ./services/data_collector/src:/app/src
      - ./shared:/shared
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MONGO_HOST=${MONGO_HOST}
      - MONGO_PORT=${MONGO_PORT}
      - MONGO_USER=${MONGO_USER}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MONGO_DB=${MONGO_DB}
      - BATCH_LIMIT=${DATA_COLLECTOR_LIMIT}
    networks:
      - floresta-net

  data_governance:
    build:
      context: .
      dockerfile: services/data_governance/Dockerfile
    depends_on:
      - redis
      - mongo
    volumes:
      - ./services/data_governance/src:/app/src
      - ./shared:/shared
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MONGO_HOST=${MONGO_HOST}
      - MONGO_PORT=${MONGO_PORT}
      - MONGO_USER=${MONGO_USER}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MONGO_DB=${MONGO_DB}
    networks:
      - floresta-net

  llm_tuner:
    build:
      context: .
      dockerfile: services/llm_tuner/Dockerfile
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    depends_on:
      - redis
      - mongo
    volumes:
      - ./services/llm_tuner/src:/app/src
      - ./shared:/shared
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MONGO_HOST=${MONGO_HOST}
      - MONGO_PORT=${MONGO_PORT}
      - MONGO_USER=${MONGO_USER}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MONGO_DB=${MONGO_DB}
    networks:
      - floresta-net

  monitor:
    build:
      context: .
      dockerfile: services/monitor/Dockerfile
    depends_on:
      - redis
      - mongo
    volumes:
      - ./services/monitor/src:/app/src
      - ./shared:/shared
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - MONGO_HOST=${MONGO_HOST}
      - MONGO_PORT=${MONGO_PORT}
      - MONGO_USER=${MONGO_USER}
      - MONGO_PASSWORD=${MONGO_PASSWORD}
      - MONGO_DB=${MONGO_DB}
    networks:
      - floresta-net

volumes:
  mongo_data:

networks:
  floresta-net:
    driver: bridge
